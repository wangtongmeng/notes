

# webpack5性能优化

本项目使用的是 wbepack 5.105.2

## 1.初始化项目

```bash
mkdir webpack5_optimize
cd webpack5_optimize
npm init -y
npm i webpack webpack-cli html-webpack-plugin webpack-dev-server cross-env -D
```

### webapck.config.js

```js
const path = require('path');

module.exports = {
    mode: 'none', // development
    devtool: 'source-map',
    context: process.cwd(),
    entry: './src/index.js',
    output: {
        path: path.resolve(__dirname, 'dist'),
        filename: '[name].js'
    }
}
```

### package.json

```diff
{
  "scripts": {
+    "build": "webpack",
+    "start": "webpack serve"
  },
}

```

### src/index.js

```js
console.log(1)
```

运行`npm run start`，  访问`http://localhost:8080/main.js`，能看到文件

## 2.打包数据分析

### 日志美化

- friendly-errors-webpack-plugin 可以识别某些类别的webpack错误，并清理，聚合和优先级，以提供更好的开发人员体验

#### 安装插件

```bash
npm i friendly-errors-webpack-plugin node-notifier -D --force
```

#### webpack.config.js

```diff
const path = require('path');
+const FriendlyErrorsWebpackPlugin = require('friendly-errors-webpack-plugin');
+const notifier = require('node-notifier');
+const icon = path.join(__dirname, 'icon.png')

module.exports = {
    mode: 'none', // 配置模式 development
    devtool: 'source-map', // 调试工具选择
    context: process.cwd(), // 上下文目录
    entry: './src/index.js',
    output: {
        path: path.resolve(__dirname, 'dist'), // 输出路径
        filename: '[name].js' // 输出文件名
    },
+    plugins: [
+        new FriendlyErrorsWebpackPlugin({
+            onErrors: (severity, errors) => {
+                let error = errors[0]
+                notifier.notify({
+                    title: 'webpack编译失败',
+                    message:severity + ":" + error.name,
+                    subtitle: error.file || '',
+                    icon
+                })
+            }
+        })
+    ]
}
```

### 速度分析

- speed-measure-webpack5-plugin 可以分析打包速度

#### 安装

```bash
npm i speed-measure-webpack5-plugin -D  --force
```

#### webpack.config.js

```diff
+const icon = path.join(__dirname, 'icon.png')
+const SpeedMeasureWebpack5Plugin = require('speed-measure-webpack5-plugin');
+const smw = new SpeedMeasureWebpack5Plugin();

+module.exports = smw.wrap({
	...
+});
```

### 文件体积监控

- Web pack-bundle-analyzer 是一个webpack的插件，需要配合webpack和webpack-cli一起使用。这个插件的功能是生成代码分析报告，帮助提升代码质量和网站性能
- 它可以直观分析打包出的文件包含哪些，大小占比如何，模块包含关系，依赖项，文件是否重复，压缩后大小如何，针对这些，我们可以进行文件分析操作。

#### 安装

```bash
npm i webpack-bundle-analyzer -D --force
```

#### 编译启动

##### webpack.config.js

```diff
+const {BundleAnalyzerPlugin} = require('webpack-bundle-analyzer');


module.exports = smw.wrap({
 		...
    plugins: [
       	...
+        new BundleAnalyzerPlugin()
    ]
});
```

##### package.json

```diff
{
  "scripts": {
+      "dev": "webpack --progress"
    },
}
```

运行 npm run dev，会自动打开 http://127.0.0.1:8888/

![](http://cdn.wangtongmeng.com/20260225132138.png)

#### 单独启动

##### webpack.confg.js

```diff
module.exports = smw.wrap({
    plugins: [
        new BundleAnalyzerPlugin({
+            analyzerMode: 'disabled', // 不启动展示打包报告的HTTP服务器
+            generateStatsFile: true // 要生成stats.json描述文件
        })
    ]
});
```

##### package.json

```diff
{
  "scripts": {
    "dev": "webpack --progress",
+    "analyzer": "webpack-bundle-analyzer --port 8888 ./dist/stats.json"
  },
}

```

此时打包项目会生成 dist/stats.json文件，包含项目体积信息

运行`npm run analyzer`，也可以启动可视化服务

## 3.编译时间优化

- 减少要处理的文件
- 缩小查找的范围

### 3.1 缩小查找范围

#### 3.1.1 extensions

- 指定`extensions`之后可以不用`require`或是`import`的时候加文件扩展名
- 查找的时候会依次尝试添加扩展名进行匹配

```diff
resolve: {
+		extensions: [".js", ".jsx", ".json"]
},
module: {
```

#### 3.1.2 alias

- 配置别名可以加快webpack查找模块的速度
- 每当引入bootstrap模块的时候，它会直接引入`bootstrap`，而不需要从`node_modules`文件夹中按模块的查找规则查找

##### 3.1.2.1 安装

```bash
npm i bootstrap@5 --legacy-peer-deps
```

##### 3.1.2.2 src/index.js

```js
let title = require('./title');
require('bootstrap'); // 这里是别名
console.log(title);

```

##### 3.1.2.3 webpack.config.js

```diff
+const bootstrap = path.resolve(__dirname, 'node_modules/bootstrap/dist/css/bootstrap.css');

module.exports = smw.wrap({
+    resolve: {
+        alias: {
+             bootstrap,
+        }
+    },
+    module: {
+        rules: [
+            {
+                test: /\.css$/,
+                use: [
+                    'style-loader',
+                    'css-loader',
+                ]
+            }
+        ]
+    },
});
```

#### 3.1.3 modules

- 对于直接声明依赖名的模块webpack会使用类似`Nodejs`一样进行路径搜索，搜索`node_modules`目录
- 如果可以确定项目内所有的第三方依赖模块都是在项目目录下的`node_modules`中的话可以直接指定
- 默认配置

```diff
module.exports = smw.wrap({
    resolve: {
+        modules: ["c:/node_modules", "node_modules"], // 指定查找目录，如果我们知道依赖在c:/node_modules，就方前面
        mainFields: ["style"], // 默认先找依赖的main文件，这里可以设置先找style文件
    },
});
```

#### 3.1.4 mainFields

- 默认情况下`package.json`文件按照文件中`main`字段的文件名来查找文件

```diff
resolve: {
				// 配置 target === "web" 或者 target === "webworker" 时 mainField 默认值是：
+        mainFields: ['browser', 'module', 'main'], // 从package.json中的哪个字段查找入口文件
        // target 的值为其他时，mainFields 默认值为:
+				mainFields: ['module', 'main'],
    },
```

#### 3.1.5 mainFiles

- 当目录下没有`package.json`文件时，我们说会默认使用目录下的`index.js`这个文件

```diff
resolve: {
+		mainFiles: ['index']
}
```

#### 3.1.6 oneOf

- 每个文件对于rules中的所有规则都会遍历一遍，如果使用oneOf就可以解决问题，只要能匹配一个即可推出
- 在oneOf中不能两个配置处理同一个类型文件

Webpack.confg.js

```diff
 module: {
        rules: [
+            {
+                oneOf: [ // oneOf 只可能匹配数组中的某一个，找到一个不再继续查找剩下的
                    {
                        test: /\.css$/,
                        use: [
                            'style-loader',
                            'css-loader',
                        ]
                    },
                    {
                        test: /\.less$/,
                        use: [
                            'style-loader',
                            'css-loader',
                            'less-loader'
                        ]
                    },
+                ]
+            }
        ]
    },
```

#### 3.1.7 externals

- 如果我们想引用一个库，但是又不想让webpack打包，并且又不影响我们在程序中以CMD、AMD或者window/global全局等方式进行使用，那就可以配置`externals`

##### 3.1.7.1 安装

```bash
npm i jquery html-webpack-externals-plugin -D
```

##### 3.1.7.2 使用 jquery

src/index.js

```js
// const jQuery = require("jquery");
// import jQuery from 'jquery';

// 模块里也能用
let $ = require('jquery') // window.jQuery
console.log($);

```

##### 3.1.7.3 src/index.html

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.js"></script>
    <script>
        // 全局能用
        console.log(jQuery);
        
    </script>
</body>
</html>
```

##### 3.1.7.4 webpack.config.js

```diff
+externals: {
+      jquery: 'jQuery' // 项目中引入jquery，会去找window.jQuery
+  },
```

#### 3.1.8 resovleLoader

resolveLoader和reosolve的配置一致，是用来找loader的，只对loader有用

##### 3.1.8.1 loaders/logger-loader.js

```js
function loader(source) {
    console.log('@@@@logger-loader@@@@');
    
    return source;
}
module.exports = loader 
```

##### 3.1.8.2 webpack.config.js

```diff
+const loadersPath = path.resolve(__dirname, 'loaders')

module.exports = {
    resolve: { // 找普通模块
        extensions: ['.js', '.jsx', '.json'], // 指定文件扩展名左边的优先级更高，先找js文件，找不到再往后找
        alias: { // 指定查找别名
            bootstrap,
        },
        modules: ["c:/node_modules", "node_modules"], // 指定查找目录
        mainFields: ['browser', 'module', 'main'], // 从package.json中的哪个字段查找入口文件
        mainFiles: ['index'], // 如果找不到mainFields的话，会找索引文件，index.js
    },
+    resolveLoader: { // 找loader，只对loader有用
        // 内部字段和resolve一样
+        modules: [loadersPath, 'node_modules'] // node_modules也需要加上，这是默认的，先找loadersPath目录，找不到找node_modules
+    },
    module: {
        rules: [
            {
                oneOf: [ // oneOf 只可能匹配数组中的某一个，找到一个不再继续查找剩下的
                    {
                        test: /\.css$/,
                        use: [
+                            'logger-loader',
                            'style-loader',
                            'css-loader',
                        ]
                    },
                ]
            }
        ]
    },
};
```

##### 3.1.8.3 src/index.js

```js
import './index.css'
```

##### 3.1.8.4 src/index.css

```css
body {
    background-color: green;
    color: red;
}
```

### 3.2 noParse

- `module.noParse`字段，可以用于配置哪些模块文件的内容不需要进行解析
- 不需要解析依赖（即无依赖）的第三方大型类库等，可以通过这个字段来配置，以提高整体的构建速度
- 使用`noParse`进行忽略的模块文件中不能使用`import`、`require`等语法

> 像一些工具库没有依赖 import require这些，例如 lodash require

#### 3.2.1 src/index.js

```js
let title = require('./title');
console.log(title);
```

#### 3.2.2 src/title.js

```js
let name = require('./name');
module.exports = `hello ${name}`;
```

#### 3.2.4 webpack.config.js

```diff
module.exports = {
    module: {
+        // 如果模块的路径匹配此正则的话，就不需要去查找里面的依赖项 requrie import
+        noParse: /title.js/, // 正则表达式
    },
};
```

打包结果

添加noParse前，有name.js

```
modules by path ./src/*.js 139 bytes
    ./src/index.js 51 bytes [built] [code generated]
    ./src/title.js 63 bytes [built] [code generated]
    ./src/name.js 25 bytes [built] [code generated]
webpack 5.105.2 compiled successfully in 269 ms
```

添加后，没有，**说明没有解析title的依赖项，也就没有分割文件**

```
modules by path ./src/*.js 114 bytes
    ./src/index.js 51 bytes [built] [code generated]
    ./src/title.js 63 bytes [built] [code generated]
webpack 5.105.2 compiled successfully in 352 ms
```

npm start启动后发现会报错，因为没有解析

```
Uncaught ReferenceError: require is not defined
    at Object.<anonymous> (title.js:1:1)
    at __webpack_require__ (bootstrap:22:1)
    at fn (hot module replacement:61:1)
    at Object.<anonymous> (index.js:1:13)
    at __webpack_require__ (bootstrap:22:1)
    at startup:6:1
    at startup:6:1
```

### 3.3 IgnorePlugin

- Ignore-pulign 用于忽略某些特定的模块，让 web pack 不把这些指定的模块打包进去
- requestRegExp 匹配(test)资源请求路径的正则表达式
- contextRegExp（可选）匹配(test)资源上下文（目录）的正则表达式。
- moment会将所有本地化内容和核心功能一起打包，你可使用`IgnorePlugin`在打包时忽略本地化内容

#### 3.3.1 安装

```bash
npm i moment -S --legacy-peer-deps
```

#### 3.3.2 src/index.js

```js
import moment from 'moment';
console.log(moment);
```

npm run build，打包后，main.js 682k

```
asset main.js 682 KiB [emitted] (name: main) 1 related asset
asset index.html 401 bytes [compared for emit]
runtime modules 1.04 KiB 5 modules
modules by path ./node_modules/moment/locale/*.js 512 KiB
  ./node_modules/moment/locale/af.js 2.69 KiB [built] [code generated]
  ./node_modules/moment/locale/ar.js 6.03 KiB [built] [code generated]
  ./node_modules/moment/locale/ar-dz.js 5.29 KiB [built] [code generated]
  ./node_modules/moment/locale/ar-kw.js 2.42 KiB [built] [code generated]
  ./node_modules/moment/locale/ar-ly.js 5.56 KiB [built] [code generated]
  ./node_modules/moment/locale/ar-ma.js 2.47 KiB [built] [code generated]
  ./node_modules/moment/locale/ar-ps.js 4.01 KiB [built] [code generated]
  ./node_modules/moment/locale/ar-sa.js 3.69 KiB [built] [code generated]
  ./node_modules/moment/locale/ar-tn.js 2.42 KiB [built] [code generated]
  + 128 modules
./src/index.js 49 bytes [built] [code generated]
./node_modules/moment/moment.js 172 KiB [built] [code generated]
./node_modules/moment/locale/ sync ^\.\/.*$ 3.26 KiB [optional] [built] [code generated]
webpack 5.105.2 compiled successfully in 390 ms
wangtongmeng@MacBook-Pro-2 webpack5_optimize % 
```



#### 3.3.3 webpack.config.js

```diff
+const webpack = require('webpack');

module.exports = {
    plugins: [
+        new webpack.IgnorePlugin({
+            // 打包忽略 moment下的locale
+            resourceRegExp:  /^\.\/locale$/, // 资源正则，不打包语言包 // 需要哪个语言包单独引入 import 'moment/locale/zh-cn';
+            contextRegExp: /moment$/ // 上下文，目录正则
+        })

    ]
};
```

`npm run build` 打包后，main.js 只有176k

```
sset main.js 176 KiB [emitted] (name: main) 1 related asset
asset index.html 401 bytes [compared for emit]
runtime modules 1.04 KiB 5 modules
cacheable modules 172 KiB
  ./src/index.js 49 bytes [built] [code generated]
  ./node_modules/moment/moment.js 172 KiB [built] [code generated]
webpack 5.105.2 compiled successfully in 219 ms
```

### 3.4 thread-loader（多进程）

- 把thread-loader放置在其他loader之前，放置在这个loader之后的loader就会在一个单独的worker池（worker pool）中运行
- include 表示哪些目录中的`.js`文件需要进行 `babel-loader`
- exclude 表示哪些目录中的`.js`文件不要进行`babel-loader`
- `exclude`的优先级高于`include`，尽量避免`exclude`，更倾向于使用`include`

#### 3.4.1 安装

```bash
npm i thread-loader babel-loader @babel/core @babel/preset-env -D  --legacy-peer-deps
```

#### webpack.config.js

```diff

module.exports = {
    module: {
        // 如果模块的路径匹配此正则的话，就不需要去查找里面的依赖项 requrie import
        noParse: /title.js/,
        rules: [
            {
                oneOf: [ // oneOf 只可能匹配数组中的某一个，找到一个不再继续查找剩下的
+                    {
+                        test: /\.js$/,
+                        include: path.resolve(__dirname, "src"),
+                        exclude: /node_modules/, // 不解析 node_modules
+                        use: [
+                            // thread-loader开启线程池，开线程和线程通信都需要时间，适合资源很多的项目
+                            {
+                                loader: 'thread-loader',
+                                options: {workers: 3} // 数量cpu核数-1
+                            },
+                            'babel-loader'
+                        ]
+                    },
                ]
            }
        ]
    },
};
```

### 3.5 利用缓存

- 利用缓存可以提升重复构建的速度

#### 3.5.1 babel-loader

- Babel 在转义js文件过程中消耗性能较高，将babel-loader执行的结果缓存起来，当重新打包构建时尝试读取缓存，从而提高打包构建速度、降低消耗
- 默认存放位置是`node_modules/.cache/babel-loader`

```diff
{
                        test: /\.js$/,
                        include: path.resolve(__dirname, "src"),
                        exclude: /node_modules/, // 不解析 node_modules
                        use: [
                            // thread-loader开启线程池，开线程和线程通信都需要时间，适合资源很多的项目
                            {
                                loader: 'thread-loader',
                                options: {workers: 3} // 数量cpu核数-1
                            },
+                            {
+                                loader: 'babel-loader',
+                                options: {
+                                    cacheDirectory: true // 启用babel缓存
+                                }
+                            },
                        ]
                    },
```

#### 3.5.2 cache-loader

- 在一些性能开销较大laoder之前添加此cache-loader，可以将结果缓存在磁盘中
- 默认保存在`node_modules/.cache/cache-loader`目录中

```bash
npm i cache-loader -D  --legacy-peer-deps
```

```diff
{
    test: /\.css$/,
    use: [
+        'cache-loader',
        'logger-loader',
        'style-loader',
        'css-loader',
    ]
},
```

src/index.js

```diff
+import './index.css';
import moment from 'moment';
import 'moment/locale/zh-cn';
console.log(moment);
```

#### 3.5.3 hard-source-webpack-plugin

- `HardSourceWebpackPlugin`为`模块`提供中间缓存，缓存默认的存放路径是`node_module/.cache/hard-source
- 配置`hard-source-webpack-plugin`后，首次构建时间并不会有太大的变化，但是从第二次开始，构建时间大约可以减少`80%`左右
- webpack5中已经内置了模块缓存，**不需要再使用此插件**

##### 3.5.3.1 安装

```bash
npm i hard-source-webpack-plugin -D  --legacy-peer-deps
```

##### 3.5.3.2 webpack.config.js

```diff

+let HardSourceWebpackPlugin = require('hard-source-webpack-plugin');

module.exports = {
    plugins: [
+        new HardSourceWebpackPlugin()
    ]
};
```

## 4.编译体积优化

### 4.1 压缩JS、CSS、HTML和图片

- optimize-css-assets-webpack-plugin 是一个优化和压缩CSS资源的插件
- terser-webpack-plugin 是一个优化和压缩JS资源的插件
- Image-web pack-loader可以帮助我们对图片进行压缩和优化

#### 4.1.1 安装

```bash
npm i terser-webpack-plugin optimize-css-assets-webpack-plugin image-webpack-loader -D --legacy-peer-deps
```

#### 4.1.2 webpack.confg.js

```diff
+const OptimizeCssAssetsWebpackPlugin = require('optimize-css-assets-webpack-plugin')
+const TerserPlugin = require('terser-webpack-plugin');

module.exports = {
+    optimization: {
+        minimize: true, // 开启最小化
+        minimizer: [
+            new TerserPlugin(), // 压缩JS
+        ]
+    },
    module: {
        // 如果模块的路径匹配此正则的话，就不需要去查找里面的依赖项 requrie import
        noParse: /title.js/,
        rules: [
            {
                oneOf: [ // oneOf 只可能匹配数组中的某一个，找到一个不再继续查找剩下的
                    {
+                        // https://www.npmjs.com/package/image-webpack-loader  参考配置用力改
+                        test: /\.jpg|png|gif|bmp$/,
+                        use: [
+                            {
+                                loader: 'image-webpack-loader',
+                                options: {
+                                    mozjpeg: {
+                                        progressive: true,
+                                    },
+                                    // optipng.enabled: false will disable optipng
+                                    optipng: {
+                                        enabled: false,
+                                    },
+                                    pngquant: {
+                                        quality: [0.65, 0.90],
+                                        speed: 4
+                                    },
+                                    gifsicle: {
+                                        interlaced: false,
+                                    },
+                                    // the webp option will enable WEBP
+                                    webp: {
+                                        quality: 75
+                                    }
+                                }
+                            }
+                        ]
                    },
                ]
            }
        ]
    },
    plugins: [
        new HtmlWebpackPugin({
            template: './src/index.html',
+            minify: { // 压缩html
+                collapseWhitespace: true, // 去掉空格
+                removeComments: true, // 去掉注释
+            }
        }),
    ]
};
```



### 4.2 清除无用的CSS

- purgecss-webpack-plugin 单独提取CSS并清除用不到的CSS

#### 4.2.1 安装

```bash
npm i purgecss-webpack-plugin mini-css-extract-plugin -D --legacy-peer-deps
```

#### 4.2.3 src/index.js

```js
import './index.css';
```

#### 4.2.4 src/index.css

```diff
body {
    background-color: green;
    color: red;
}

#root {
    color: red;
}

+/* 没用到的css */
+#other {
+    color: green;
+}
```

#### 4.2.5 src/index.html

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.js"></script>
    <script>
        // 全局能用
        console.log(jQuery);
        
    </script>
    <button class="btn btn-primary">btn-primary</button>
    <div id="root">root</div>
</body>
</html>
```

#### 4.2.6 webpack.config.js

```diff
// 因为CSS和JS的加载可以并行，所以可以通过此插件提取CSS成单独的文件，然后去掉无用的CSS并进行压缩
+const MiniCssExtractPlugin = require('mini-css-extract-plugin')
+const { PurgeCSSPlugin } = require("purgecss-webpack-plugin"); // https://www.npmjs.com/package/purgecss-webpack-plugin

+// global.sync(`${PATHS.src}/**/*`, {nodir: true})
+const glob = require('glob') // 文件匹配模式
+const PATHS = {
+    src: path.resolve(__dirname, 'src')
+}

+module.exports = {
+    plugins: [
+        new MiniCssExtractPlugin({
+            filename: '[name].css'
+        }),
+        new PurgeCSSPlugin({
+            paths: glob.sync(`${PATHS.src}/**/*`, {nodir: true}) // 净化src下的所有文件 **匹配任意字符，包含路径分隔符，*匹配任意字符，不包含路径分隔符
+        }),
+    ]
};
```

## 其他

### 6.1环境

#### 6.1.1 模式(mode)

- 日常的前端开发工作中，一般会有两套构建环境
- 一套开发时使用，构建结果用于本地开发调试，不进行代码压缩，打印 debug 信息，包含 sourcemap 文件
- 一套构建后的结果是直接应用于线上的，即代码都是压缩后，运行时不打印 debug 信息，静态文件不包括 sourcemap
- webpack 4.x 版本引入了 mode 的概念
- 当你指定使用 production mode 时，默认会启用各种性能优化的功能，包括构建结果优化以及 webpack 运行性能优化
- 而如果是 development mode 的话，则会开发 debug 工具，运行时打印详细的错误信息，以及更加快速的增量编译构建

| 选项        | 描述                                                         |
| ----------- | ------------------------------------------------------------ |
| development | 会将 process.env.NODE_ENV 的值设成 development。启用 NamedChunksPlugin 和 NamedModulesPlugin |
| production  | 会将 process.env.NODE_ENV 的值设成 production。启用 FlagDependencyUsagePlugin，FlagIncludedChunksPlugin，ModuleConcatenationPlugin，N oEmitOnErrosPlugin，OccurrenceOrderPlugin，SideEffectsFlagPlugin 和 UglifyJsPlugin |

#### 6.1.2 环境差异

- 开发环境
  - 需要生成 sourcemap 文件
  - 需要打印 debug 信息
  - 需要 live reload 或者 hot reload 的功能
- 生产环境
  - 可能需要分离 CSS 成单独的文件，以便多个页面共享同一个 CSS 文件
  - 需要压缩 HTML/CSS/JS 代码
  - 需要压缩图片
- 其默认值为 production

#### 6.1.3 区分环境

- `--mode`用来设置模块内的 `process.env.NODE_ENV`
  - mode优先级 默认的mode（production）低于 webpack.confg.js中的mode 低于命令中的mode
- `--env`用来设置wbepack配置文件的函数参数
- cross-env 用来设置node环境的 `process.env.NODE_ENV`
- dotenv 可以按需加载不同的环境变量文件
- define-plugin 用来配置在 `编译时候` 用的 `全局变量`

##### 6.1.3.1 安装

```bash
npm i cross-env dotenv terser-webpack-plugin optimize-css-assets-webpack-plugin -D  --legacy-peer-deps
```

##### 6.1.3.2 mode默认值

- webpack的默认值为`production`
- `webpack serve`的mode默认为`development `
- 可以在模块内通过`process.env.NODE_ENV`获取当前的环境变量，无法在`webpack配置文件`中获取此变量

```js
"scripts": {
	"build": "webpack",
  "start": "webpack serve"
}
```

index.js

```
console.log('src/index.js process.env.NODE_ENV', process.env.NODE_ENV); // 模块文件中的process.env.NODE_ENV，和webpack.config.js中的process.env.NODE_ENV没有关系
```

webpack.config.js

```diff
+console.log('webpack.config.js process.env.NODE_ENV', process.env.NODE_ENV); // 默认值是undefined node环境的环境变量

module.exports = {
+    // mode: 'none', // 配置模式 development
    ]
};
```

`npm run build`打包后,

terminal控制台显示 `webpack.config.js process.env.NODE_ENV undefined`

而dist/main.js的内容，有值

```js
console.log("src/index.js process.env.NODE_ENV","production");
//# sourceMappingURL=main.js.map
```

##### 6.1.3.3 命令行传 mode

package.json

```diff
"scripts": {
+    "build": "webpack --mode=development",
+    "start": "webpack serve --mode=development serve",
  },
```

webpack.confg.js

```diff
module.exports = {
+    	mode: 'production',
    ]
};
```

`npm run build`打包后,

node环境打印还是 undefined

而dist/main.js的内容，有值，**--mode的值会覆盖默认值和webpack.config.js中配置的mode的值**

```diff
/*! For license information please see main.js.LICENSE.txt */
+console.log("src/index.js process.env.NODE_ENV","development");
//# sourceMappingURL=main.js.map
```

##### 6.1.3.4 命令行传 env

package.json

```diff
"scripts": {
+    "build": "webpack --env=development",
    "start": "webpack serve",
  },
```

webpack.config.js

```diff
console.log('webpack.config.js process.env.NODE_ENV', process.env.NODE_ENV); // 默认值是undefined node环境的环境变量

+module.exports = (env) => {
+    console.log('webpack.config.js env', env);
    
    return {
  	}
+};
```

`npm run build`打包后,

node环境，打印的env有值，是**传给了webpack.config.js的函数参数env**

```diff
webpack.config.js process.env.NODE_ENV undefined
+webpack.config.js env { WEBPACK_BUNDLE: true, WEBPACK_BUILD: true, development: true }
```

而dist/main.js的内容，还是默认值production

```diff
console.log("src/index.js process.env.NODE_ENV","production");
//# sourceMappingURL=main.js.map
```

如果想通过env设置mode的值，只需要增加判断即可

webpack.config.js

```diff
module.exports = (env) => {
    console.log('webpack.config.js env', env);
    
    return {
+			mode: env.development ? 'development' : 'production',   
  	}
};
```

`npm run build`打包后，dist/main.js的内容就是development了

```diff
/*! For license information please see main.js.LICENSE.txt */
+console.log("src/index.js process.env.NODE_ENV","development");
//# sourceMappingURL=main.js.map
```

##### 6.1.3.5 mode配置

```js
module.exports = {
  mode: 'development'
}
```

##### 6.1.3.6 DefinePlugin

- 设置全局变量（不是 `window`），所有模块都能读到该变量的值
- 可以在任意**模块内**通过 `process.env.NODE_ENV`获取当前的环境变量
- 但无法在`node环境`（webpack配置文件中）下获取当前的环境变量

src/index.js

```diff
console.log('src/index.js process.env.NODE_ENV', process.env.NODE_ENV); // 模块文件中的process.env.NODE_ENV，和webpack.config.js中的process.env.NODE_ENV没有关系
+console.log('ENVIRONMENT', ENVIRONMENT);
```

webpack.confg.js

```js
console.log('webpack.config.js process.env.NODE_ENV', process.env.NODE_ENV); // undefined
console.log("NODE_ENV", NODE_ENV) // ReferenceError: NODE_ENV is not defined

module.exports = {
  mode: 'development',
  plugins: [
    // 定义在编译阶段使用的全局变量进行替换，在浏览器运行阶段就已经是值了
    new webpack.DefinePlugin({
        'process.env.NODE_ENV': JSON.stringify('development'), // 注意用双引号引起来，否则就变成变量了。等价于"\"development\""
        'NODE_ENV': JSON.stringify('production'),
        "ENVIRONMENT": JSON.stringify("development"),
    })
  ]
}
```

注释掉webpack.config.js中的`console.log("NODE_ENV", NODE_ENV)`打包，ENVIRONMENT变量被替换成值了

```diff
/*! For license information please see main.js.LICENSE.txt */
console.log("src/index.js process.env.NODE_ENV","development"),console.log("ENVIRONMENT","development");
//# sourceMappingURL=main.js.map
```

##### 6.1.3.7 cross-env

cross-env 可以跨操作系统，设置process.env中的key的值

cross-env的值会传到node环境变量中NODE_ENV=development，则会传入process.env.NODE_ENV

package.json

```json
"scripts": {
    "build": "cross-env NODE_ENV=development webpack",
  },
```

webpack.config.js

```diff
console.log('webpack.config.js process.env.NODE_ENV', process.env.NODE_ENV); // development

module.exports = {
  mode: 'development',
  plugins: [
    // 定义在编译阶段使用的全局变量进行替换，在浏览器运行阶段就已经是值了
    new webpack.DefinePlugin({
+        'process.env.NODE_ENV': JSON.stringify(process.env.NODE_ENV), // 注意用双引号引起来，否则就变成变量了。等价于"\"development\""
        'NODE_ENV': JSON.stringify('production'),
        "ENVIRONMENT": JSON.stringify("development"),
    })
  ]
}
```

打包后，dist/main.js

```js
console.log("src/index.js process.env.NODE_ENV","development"),console.log("ENVIRONMENT","development");
//# sourceMappingURL=main.js.map
```

##### 6.1.3.8 .env文件

.env

```
NODE_ENV=production1
```



package.json

```json
"scripts": {
    "build": "webpack",
    "start": "webpack  serve",
  },
```

webpack.config.js

```diff
// 可以读取.env文件，获取里面的值，设置到process.env.NODE_ENV里面
+require('dotenv').config();
+console.log('webpack.config.js process.env.NODE_ENV', process.env.NODE_ENV); // production1

module.exports = (env={}) => {
    console.log('webpack.config.js env', env);
    return {
        mode: env.development ? 'development' : 'production',
        plugins: [
            new webpack.DefinePlugin({
+                'process.env.NODE_ENV': JSON.stringify(process.env.NODE_ENV), // 注意用双引号引起来，否则就变成变量了
                'NODE_ENV': JSON.stringify('production'),
                "ENVIRONMENT": JSON.stringify("development"),
            })

        ]
    }
};


```

打包文件 dist/main.js

```diff
+console.log("src/index.js process.env.NODE_ENV","production1"),console.log("ENVIRONMENT","development");
//# sourceMappingURL=main.js.map
```

















